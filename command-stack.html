<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Command 기능(BPMN Task 색상 변경)</title>
  <link rel="stylesheet" href="./vendor/bpmn-js/assets/diagram-js.css" />
  <link rel="stylesheet" href="./vendor/bpmn-js/assets/bpmn-font/css/bpmn-embedded.css" />
  <link rel="stylesheet" href="./vendor/bpmn-js/assets/bpmn-font/css/properties-panel.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
    }

    #controls {
      padding: 10px;
      background: #f0f0f0;
    }

    #main {
      flex: 1;
      display: flex;
      height: 100%;
    }

    #canvas {
      flex: 1;
      height: 100%;
    }

    #properties {
      width: 300px;
      border-left: 1px solid #ccc;
    }

    .bjs-properties-panel {
      font-family: sans-serif;
      font-size: 13px;
    }
      .djs-element.blue-task .djs-visual > :nth-child(1) {
    fill: blue !important;
  }

  .djs-element.red-task .djs-visual > :nth-child(1) {
    fill: red !important;
  }
  </style>
</head>
<body>
  <h3 style="margin-left: 20px;padding-top: 10px;">
    변경 내용 : Task객체를 클릭 시 Name: 진행중 => Blue, Name: 종료 => red로 변경<br />
    우측 속성 패널(General > Name)에서 Task 이름을 진행중이나 종료로 변경해도 색상이 자동으로 갱신됩니다.
  </h3>
  <div id="main">
    <div id="canvas"></div>
    <div id="properties"></div>
  </div>

  <!-- BPMN JS -->
  <!-- <script src="./vendor/bpmn-js/assets/bpmn-modeler-v11.5.0.js"></script> -->
  <script src="./vendor/bpmn-js/assets/bpmn-modeler-v18.6.2.js"></script>

  <!-- Properties Panel -->
  <script src="./vendor/bpmn-js/assets/bpmn-js-properties-panel-v5.30.0.js"></script>


  <script>
    (async function () {

    const camundaModdle = await fetch('./json/camundaModdle.json').then(response => response.json());
    const customModdle = await fetch('./json/customModdle.json').then(response => response.json());
    const bpmnXML = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                  xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
                  id="Definitions_1"
                  targetNamespace="http://bpmn.io/schema/bpmn">
  <bpmn:process id="Process_1" isExecutable="true">
    <bpmn:task id="Task_1" name="진행중"/>
    <bpmn:task id="Task_2" name="종료"/>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
      <bpmndi:BPMNShape id="Task_1_di" bpmnElement="Task_1">
        <dc:Bounds x="100" y="100" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_2_di" bpmnElement="Task_2">
        <dc:Bounds x="250" y="100" width="100" height="80"/>
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;

    const bpmnModeler = new BpmnModeler({
      container: '#canvas',
      propertiesPanel: {
        parent: '#properties',
      },
      additionalModules: [
        window.BpmnJSPropertiesPanel.BpmnPropertiesPanelModule,
        window.BpmnJSPropertiesPanel.BpmnPropertiesProviderModule,
        window.BpmnJSPropertiesPanel.CamundaPlatformPropertiesProviderModule,
        window.BpmnJSPropertiesPanel.CamundaPlatformTooltipProvider,
        // {
        //   __init__: ['customPropertiesProvider'],
        //   customPropertiesProvider: ['type', CustomPropertiesProvider]
        // }
      ],
      moddleExtensions: {
        camunda: camundaModdle,
        custom: customModdle
      }
    });

    bpmnModeler.importXML(bpmnXML).then(() => {
      const canvas = bpmnModeler.get('canvas');
      const eventBus = bpmnModeler.get('eventBus');

      requestAnimationFrame(() => {
        // 현재 뷰박스 얻기
        const viewbox = canvas.viewbox();

        // 원하는 위치로 이동
        canvas.viewbox({
          x: -40,
          y: 0,
          width: viewbox.width,
          height: viewbox.height
        });
      });

      // 클래스 제거 및 추가를 통한 색상 적용
      const updateTaskColor = (element) => {
        if (!element || element.type !== 'bpmn:Task') return;

        // 기존 마커 제거
        canvas.removeMarker(element, 'blue-task');
        canvas.removeMarker(element, 'red-task');

        const label = element.businessObject.name;
        const id = element.businessObject.id;
        if (label === '진행중') {
          canvas.addMarker(element, 'blue-task');
        } else if (label === '종료') {
          canvas.addMarker(element, 'red-task');
        }
      };

      // 클릭 시 색상 적용
      eventBus.on('element.click', event => updateTaskColor(event.element));

      // 이름 변경 시 색상 자동 갱신
      eventBus.on('commandStack.element.updateProperties.executed', event => {
        updateTaskColor(event.context.element);
      });

    }).catch(err => console.error('BPMN 로드 오류:', err));
    })();
  </script>
</body>
</html>
