<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>BPMN 속성 패널 확장 예제</title>

    <!-- bpmn-js 기본 CSS -->
    <link rel="stylesheet" href="./vendor/bpmn-js/assets/diagram-js.css" />
    <link rel="stylesheet" href="./vendor/bpmn-js/assets/bpmn-font/css/bpmn-embedded.css" />
    <link rel="stylesheet" href="./vendor/bpmn-js/assets/bpmn-font/css/properties-panel.css" />

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: sans-serif;
      }
      #container {
        display: flex;
        height: 100%;
      }
      #canvas {
        flex: 1;
        height: 100%;
        border-right: 1px solid #ccc;
      }
      #properties {
        width: 320px;
        height: 100%;
      }
      h3 {
        margin: 12px 20px;
      }
      #save-button {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
      }
    </style>
  </head>
  <body>
    <h3>변경 내용 : Bpmn PanelModule + Camunda PanelModule 사용 + custom 속성 XML 저장</h3>
    <div id="container">
      <button id="save-button">Save XML</button>
      <div id="canvas"></div>
      <div id="properties"></div>
    </div>

    <!-- BPMN JS (로컬) -->
    <script src="./vendor/bpmn-js/assets/bpmn-modeler-v18.6.2.js"></script>

    <!-- Properties Panel (UMD) -->
    <script src="./vendor/bpmn-js/assets/bpmn-js-properties-panel-v5.30.0.js"></script>

    <script type="module">
      (async function () {
        // moddle 정의 로드
        const camundaModdle = await fetch('./json/camundaModdle.json').then(r => r.json());
        const customModdle = await fetch('./json/customModdle.json').then(r => r.json());
        // 예: { name:"Custom", uri:"http://example.com/schema/custom", prefix:"custom", ... }

        const {
          BpmnPropertiesPanelModule,
          BpmnPropertiesProviderModule,
          CamundaPlatformPropertiesProviderModule,
          CamundaPlatformTooltipProvider,
        } = window.BpmnJSPropertiesPanel;
        console.log(window.BpmnJSPropertiesPanel);
        console.log(window.BpmnJSPropertiesPanel.isTextFieldEntryEdited);

        // ------ Custom Provider ------
        class CustomPropertiesProvider {
          constructor(propertiesPanel, translate, moddle, modeling, elementRegistry, eventBus) {
            this._translate = translate;
            this._modeling = modeling;
            this._elementRegistry = elementRegistry;
            this._eventBus = eventBus;

            // import 이후 한 번 네임스페이스 보정
            eventBus.on('import.done', () => this.ensureCustomNamespace());

            propertiesPanel.registerProvider(500, this);
          }

          getGroups = element => {
            return groups => {
              const bo = element.businessObject;
              if (bo.$type !== 'bpmn:Task') return groups;

              groups.push({
                id: 'custom',
                label: this._translate('custom properties'),
                entries: [
                  {
                    id: 'taskType',
                    component: 'input',
                    label: 'Task Type',

                    get: el => {
                      const _bo = el.businessObject;
                      return (_bo.$attrs && _bo.$attrs['custom:taskType']) || '';
                    },
                    set: (el, value) => {
                      const v = (value || '').trim();

                      // 루트에 xmlns:custom 보장
                      this.ensureCustomNamespace();

                      // 값 반영 (빈값은 삭제)
                      this._modeling.updateProperties(el, {
                        'custom:taskType': v || undefined,
                      });
                    },
                  },
                ],
                tooltip: this._translate('Make sure you know what you are doing!'),
              });

              return groups;
            };
          };

          // 루트 <bpmn:definitions>에 xmlns:custom 보장
          ensureCustomNamespace() {
            try {
              const anyRoot = this._elementRegistry
                .getAll()
                .find(e => e.type === 'bpmn:Process' || e.type === 'bpmn:Collaboration');
              if (!anyRoot) return;

              const defs = anyRoot.businessObject && anyRoot.businessObject.$parent;
              if (!defs || !defs.$attrs) return;

              const prefix = (customModdle && customModdle.prefix) || 'custom';
              const uri = (customModdle && customModdle.uri) || 'http://example.com/schema/custom';
              const attr = 'xmlns:' + prefix;

              if (!defs.$attrs[attr]) {
                defs.$attrs[attr] = uri;
              }
            } catch (e) {
              // 초기 타이밍 등에서 생길 수 있는 오류는 무시
            }
          }
        }

        CustomPropertiesProvider.$inject = [
          'propertiesPanel',
          'translate',
          'moddle',
          'modeling',
          'elementRegistry',
          'eventBus',
        ];

        // ------ Modeler ------
        const bpmnModeler = new BpmnModeler({
          container: '#canvas',
          propertiesPanel: { parent: '#properties' },
          additionalModules: [
            BpmnPropertiesPanelModule,
            BpmnPropertiesProviderModule,
            CamundaPlatformPropertiesProviderModule,
            CamundaPlatformTooltipProvider,
            {
              __init__: ['customPropertiesProvider'],
              customPropertiesProvider: ['type', CustomPropertiesProvider],
            },
          ],
          moddleExtensions: {
            camunda: camundaModdle,
            custom: customModdle,
          },
        });

        // ------ Save XML ------
        document.getElementById('save-button').addEventListener('click', () => {
          bpmnModeler
            .saveXML({ format: true })
            .then(({ xml }) => {
              console.log('✅ 저장된 XML:\n', xml);
              const blob = new Blob([xml], { type: 'application/xml' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'diagram.bpmn';
              a.click();
              URL.revokeObjectURL(url);
            })
            .catch(err => console.error('❌ XML 저장 실패:', err));
        });

        // ------ 초기 다이어그램 로드 ------
        fetch('./xml/test1.xml')
          .then(r => r.text())
          .then(async xml => {
            try {
              await bpmnModeler.importXML(xml);
              // 보기 보정 (원 코드 유지)
              const canvas = bpmnModeler.get('canvas');
              requestAnimationFrame(() => {
                const viewbox = canvas.viewbox();
                canvas.viewbox({ x: -40, y: 0, width: viewbox.width, height: viewbox.height });
              });
            } catch (err) {
              console.error('Failed to load BPMN diagram:', err);
            }
          });
      })();
    </script>
  </body>
</html>
