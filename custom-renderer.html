<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Custom Renderer(Task 객체 변경)</title>

  <!-- BPMN 스타일 CDN -->
  <link rel="stylesheet" href="./vendor/bpmn-js/assets/diagram-js.css" />
  <link rel="stylesheet" href="./vendor/bpmn-js/assets/bpmn-font/css/bpmn-embedded.css" />
  <link rel="stylesheet" href="./vendor/bpmn-js/assets/bpmn-font/css/properties-panel.css" />

  <style>
    html, body, #canvas {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <h3 style="margin-left: 20px;">
    변경 내용 : Task객체가 렌더링되면 기본 색상을 노랑색이고 텍스트가 Job Proc인 Task로 오버레이 시킴(단, 라벨은 등록된 내용이 유지됨)
  </h3>
  <div id="canvas"></div>

  <!-- BPMN JS -->
  <script src="./vendor/bpmn-js/assets/bpmn-modeler-v18.6.2.js"></script>

  <script>

    class CustomRenderer {
      constructor(eventBus, styles) {
        this._eventBus = eventBus;
        this._styles = styles;

        eventBus.on('render.shape', 2000, (event) => {
          const { element, gfx } = event;
          console.log(element)
          console.log(gfx)
          if (element.type === 'bpmn:Task') {
            this.drawCustomTask(gfx, element);
            event.stopPropagation();
          }
        });
      }

      drawCustomTask(parentNode, element) {
        const SVG_NS = 'http://www.w3.org/2000/svg';
        const width = element.width || 100;
        const height = element.height || 80;

        // 사각형 생성
        const rect = document.createElementNS(SVG_NS, 'rect');
        rect.setAttribute('width', width);
        rect.setAttribute('height', height);
        rect.setAttribute('rx', 10);
        rect.setAttribute('ry', 10);
        rect.setAttribute('fill', '#ffd700');
        rect.setAttribute('stroke', '#333');
        rect.setAttribute('stroke-width', 2);
        parentNode.appendChild(rect);

        // 텍스트 생성
        const text = document.createElementNS(SVG_NS, 'text');
        text.textContent = 'Job Proc';
        text.setAttribute('x', width / 2);
        text.setAttribute('y', height / 2 + 5);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('font-size', '12px');
        text.setAttribute('font-weight', 'bold');
        parentNode.appendChild(text);
      }
    }

    CustomRenderer.$inject = ['eventBus', 'styles'];

    const customRendererModule = {
      __init__: ['customRenderer'],
      customRenderer: ['type', CustomRenderer]
    };

    const bpmnModeler = new BpmnModeler({
      container: '#canvas',
      additionalModules: [customRendererModule]
    });

    fetch('./xml/test2.xml')
      .then(response => response.text())
      .then(xml => {
        return bpmnModeler.importXML(xml).then(() => {
          const canvas = bpmnModeler.get('canvas');

          requestAnimationFrame(() => {
            // 현재 뷰박스 얻기
            const viewbox = canvas.viewbox();

            // 원하는 위치로 이동
            canvas.viewbox({
              x: -100,
              y: 0,
              width: viewbox.width,
              height: viewbox.height
            });
          });
        }).catch(err => {
          console.error('Failed to load BPMN diagram:', err);
        });
      });
  </script>
</body>
</html>
