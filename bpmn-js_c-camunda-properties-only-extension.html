<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>BPMN 속성 패널 확장 예제</title>

    <!-- bpmn-js 기본 CSS -->
    <link rel="stylesheet" href="./vendor/bpmn-js/assets/diagram-js.css" />
    <link rel="stylesheet" href="./vendor/bpmn-js/assets/bpmn-font/css/bpmn-embedded.css" />
    <link rel="stylesheet" href="./vendor/bpmn-js/assets/bpmn-font/css/properties-panel.css" />

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: sans-serif;
      }
      #container {
        display: flex;
        height: 100%;
      }
      #canvas {
        flex: 1;
        height: 100%;
        border-right: 1px solid #ccc;
      }
      #properties {
        width: 320px;
        height: 100%;
      }
      h3 {
        margin: 12px 20px;
      }
      #save-button {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        width: 100px;
        height: 30px;
      }
    </style>
  </head>
  <body>
    <!-- <h3>변경 내용 : Bpmn PanelModule + Camunda PanelModule 사용 + custom 속성 XML 저장</h3> -->
    <div id="container">
      <button id="save-button">Save XML</button>
      <div id="canvas"></div>
      <div id="properties"></div>
    </div>

    <!-- BPMN JS (로컬) -->
    <script src="./vendor/bpmn-js/assets/bpmn-modeler-v18.6.2.js"></script>

    <!-- Properties Panel (UMD) -->
    <script src="./vendor/bpmn-js/assets/bpmn-js-properties-panel-v5.30.0.js"></script>
  <script src="./utils/index.js"></script>

    <script type="module">
      (async function () {
        // moddle 정의 로드
        const camundaModdle = await fetch('./json/camundaExtentionProperties.json').then(r =>
          r.json(),
        );

        const { BpmnPropertiesPanelModule, CamundaPlatformPropertiesProviderModule } =
          window.BpmnJSPropertiesPanel;
        const qaExtension = {
          "name": "QA",
          "uri": "http://some-company/schema/bpmn/qa",
          "prefix": "qa",
          "xml": {
            "tagAlias": "lowerCase"
          },
          "types": [
            {
              "name": "AnalyzedNode",
              "extends": ["bpmn:Task"],
              "properties": [
                {
                  "name": "suitable",
                  "isAttr": true,
                  "type": "String"
                }
              ]
            }
          ]
        }

        function registerCustomRenderer(eventBus, bpmnRenderer) {
          const BaseRenderer = extractBaseRenderer(bpmnRenderer);
          class _CustomRenderer extends BaseRenderer {
            static $inject = ['eventBus', 'bpmnRenderer'];

            constructor(eventBus, bpmnRenderer) {
              super(eventBus, 1500);
              this.bpmnRenderer = bpmnRenderer;
            }

            canRender(element) {
              return !element.labelTarget;
            }


            drawShape(parentNode, element) {
              const shape = this.bpmnRenderer.drawShape(parentNode, element);
              const suitabilityScore = this.getSuitabilityScore(element);
              // console.log(suitabilityScore)
              if (suitabilityScore) {
                const color = this.getColor(suitabilityScore);
                const rect = drawRect(parentNode, element.width, 20, 2, color);
                svgAttr(rect, {
                  transform: 'translate(-20, -10)'
                });
                const text = svgCreate('text');
                svgAttr(text, {
                  fill: '#fff',
                  transform: 'translate(-15, 5)'
                });
                svgClasses(text).add('djs-label');
                svgAppend(text, document.createTextNode(suitabilityScore));
                svgAppend(parentNode, text);
              }

              return shape;
            }

            getShapePath(shape) {
              if (is(shape, 'bpmn:Task')) {
                return getRoundRectPath(shape, 2);
              }
              return this.bpmnRenderer.getShapePath(shape);
            }

            getSuitabilityScore(element) {
              const businessObject = element.businessObject;
              // console.log(businessObject)
              const { suitable } = businessObject;
              return suitable;
            }

            getColor(suitabilityScore) {
              return '#cc0000';
            }

            getShapePath(shape) {
              return this.bpmnRenderer.getShapePath(shape);
            }
          }

          const CustomRenderer = _CustomRenderer;

          return new CustomRenderer(eventBus, bpmnRenderer);
        }
        // ------ Custom Provider ------
        class CustomPropertiesProvider {
          constructor(propertiesPanel) {
            propertiesPanel.registerProvider(500, this);
          }

          getGroups = element => {
            return groups => {
              return groups.filter(g => {
                return ![
                    'CamundaPlatform__JobExecution',
                    'CamundaPlatform__ExternalTask',
                    'CamundaPlatform__CandidateStarter',
                    'CamundaPlatform__Tasklist',
                    'CamundaPlatform__HistoryCleanup',
                    'CamundaPlatform__StartInitiator',
                    'CamundaPlatform__Form',
                    'CamundaPlatform__Input',
                    'CamundaPlatform__Output',
                    'CamundaPlatform__ExecutionListener',
                    'CamundaPlatform__AsynchronousContinuations',
                    'CamundaPlatform__Implementation',
                    'CamundaPlatform__TaskListener',
                    'CamundaPlatform__UserAssignment',
                    'CamundaPlatform__FieldInjection',
                    'CamundaPlatform__Script',
                    'CamundaPlatform__CallActivity',
                    'CamundaPlatform__InMappingPropagation',
                    'CamundaPlatform__InMapping',
                    'CamundaPlatform__OutMappingPropagation',
                    'CamundaPlatform__OutMapping',
                    'CamundaPlatform__Condition',
                ].includes(g.id);
              });
            };
          };
        }

        const customModule = {
            __init__: ['customPropertiesProvider', 'customRenderer'],
            customPropertiesProvider: ['type', CustomPropertiesProvider],
            customRenderer: ['type', registerCustomRenderer]
        };
        CustomPropertiesProvider.$inject = [
          'propertiesPanel',
        ];
        // ------ Modeler ------
        const bpmnModeler = new BpmnModeler({
          container: '#canvas',
          propertiesPanel: { parent: '#properties' },
          additionalModules: [
            BpmnPropertiesPanelModule,
            CamundaPlatformPropertiesProviderModule,
            customModule,
          ],
          moddleExtensions: {
            camunda: camundaModdle,
            qa: qaExtension
          },
        });

        // ------ Save XML ------
        document.getElementById('save-button').addEventListener('click', () => {
          bpmnModeler
            .saveXML({ format: true })
            .then(({ xml }) => {
              console.log('저장된 XML:\n', xml);
              const blob = new Blob([xml], { type: 'application/xml' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'diagram.bpmn';
              a.click();
              URL.revokeObjectURL(url);
            })
            .catch(err => console.error('❌ XML 저장 실패:', err));
        });

        // ------ 초기 다이어그램 로드 ------
        fetch('./xml/test1.xml')
          .then(r => r.text())
          .then(async xml => {
            try {
              await bpmnModeler.importXML(xml);
              // 보기 보정 (원 코드 유지)
              const canvas = bpmnModeler.get('canvas');
              requestAnimationFrame(() => {
                const viewbox = canvas.viewbox();
                canvas.viewbox({ x: -40, y: 0, width: viewbox.width, height: viewbox.height });
              });
              const elementRegistry = bpmnModeler.get('elementRegistry');
              const moddle = bpmnModeler.get('moddle');
              const modeling = bpmnModeler.get('modeling');
              const eventBus = bpmnModeler.get('eventBus');
              eventBus.on('commandStack.shape.create.postExecute', event => {
                  // extensionProperties 생성
                  createExtensionProperties(event.context.shape, moddle);
              });
              // 감시할 이벤트: Extension properties 변경 감지
              eventBus.on('commandStack.element.updateModdleProperties.postExecute', (event) => {
                const { context } = event;
                const { element, properties } = context;

                // 특정 camunda:property 변경 감지
                const bo = element.businessObject;
                const extensionElements = bo.extensionElements;

                if (extensionElements && extensionElements.values) {
                  const props = extensionElements.values.find(v => v.$type === 'camunda:Properties');

                  if (props) {
                    const targetProp = props.values.find(p => p.name === '화면명');
                    if (targetProp) {

                      // model 업데이트 (extensionElements element 노드 업데이트 - updateProperties실행해야 diagram rerender됨)
                      modeling.updateProperties(element, {
                        suitable: targetProp.value
                      });
                    }
                  }
                }
              });
              elementRegistry.forEach(el => {
                  // extensionProperties 생성
                  createExtensionProperties(el, moddle);
              });
            } catch (err) {
              console.error('Failed to load BPMN diagram:', err);
            }
          });
          function createExtensionProperties (el, moddle) {
            if (el.type !== 'bpmn:Task')  return;

            const extensionProperties = moddle.create('camunda:Properties', {
                values: [
                    moddle.create('camunda:Property', {
                        name: '화면명',
                        value: '',
                    }),
                    moddle.create('camunda:Property', {
                        name: '기타사항1',
                        value: '',
                    }),
                    moddle.create('camunda:Property', {
                        name: '기타사항2',
                        value: '',
                    }),
                ],
            });

            // businessObject에 반영
            el.businessObject.extensionElements = moddle.create('bpmn:ExtensionElements', {
                values: [extensionProperties],
            });
        };
      })();
    </script>
  </body>
</html>
