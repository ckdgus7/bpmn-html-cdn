<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>BPMN 속성 패널 확장 예제</title>

    <!-- bpmn-js 기본 CSS -->
    <link rel="stylesheet" href="./vendor/bpmn-js/assets/diagram-js.css" />
    <link rel="stylesheet" href="./vendor/bpmn-js/assets/bpmn-font/css/bpmn-embedded.css" />
    <link rel="stylesheet" href="./vendor/bpmn-js/assets/bpmn-font/css/properties-panel.css" />

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: sans-serif;
      }
      #container {
        display: flex;
        height: 100%;
      }
      #canvas {
        flex: 1;
        height: 100%;
        border-right: 1px solid #ccc;
      }
      #properties {
        width: 320px;
        height: 100%;
      }
      h3 {
        margin: 12px 20px;
      }
      #save-button {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        width: 100px;
        height: 30px;
      }
    </style>
  </head>
  <body>
    <!-- <h3>변경 내용 : Bpmn PanelModule + Camunda PanelModule 사용 + custom 속성 XML 저장</h3> -->
    <div id="container">
      <button id="save-button">Save XML</button>
      <div id="canvas"></div>
      <div id="properties"></div>
    </div>

    <!-- BPMN JS (로컬) -->
    <script src="./vendor/bpmn-js/assets/bpmn-modeler-v18.6.2.js"></script>

    <!-- Properties Panel (UMD) -->
    <script src="./vendor/bpmn-js/assets/bpmn-js-properties-panel-v5.30.0.js"></script>

    <script type="module">
      (async function () {
        // moddle 정의 로드
        const camundaModdle = await fetch('./json/camundaExtentionProperties.json').then(r =>
          r.json(),
        );

        const { BpmnPropertiesPanelModule, CamundaPlatformPropertiesProviderModule } =
          window.BpmnJSPropertiesPanel;

        // ------ Custom Provider ------
        class CustomPropertiesProvider {
          constructor(propertiesPanel, translate, moddle, modeling, elementRegistry, eventBus) {
            this._translate = translate;
            this._modeling = modeling;
            this._elementRegistry = elementRegistry;
            this._eventBus = eventBus;

            propertiesPanel.registerProvider(500, this);
          }

          getGroups = element => {
            return groups => {
              return groups.filter(g => {
                return ![
                  'CamundaPlatform__Input',
                  'CamundaPlatform__Output',
                  'CamundaPlatform__ExecutionListener',
                  'CamundaPlatform__AsynchronousContinuations',
                ].includes(g.id);
              });
            };
          };
        }

        CustomPropertiesProvider.$inject = [
          'propertiesPanel',
          'translate',
          'moddle',
          'modeling',
          'elementRegistry',
          'eventBus',
        ];
        // ------ Modeler ------
        const bpmnModeler = new BpmnModeler({
          container: '#canvas',
          propertiesPanel: { parent: '#properties' },
          additionalModules: [
            BpmnPropertiesPanelModule,
            CamundaPlatformPropertiesProviderModule,
            {
              __init__: ['customPropertiesProvider'],
              customPropertiesProvider: ['type', CustomPropertiesProvider],
            },
          ],
          moddleExtensions: {
            camunda: camundaModdle,
          },
        });

        // ------ Save XML ------
        document.getElementById('save-button').addEventListener('click', () => {
          bpmnModeler
            .saveXML({ format: true })
            .then(({ xml }) => {
              console.log('저장된 XML:\n', xml);
              const blob = new Blob([xml], { type: 'application/xml' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'diagram.bpmn';
              a.click();
              URL.revokeObjectURL(url);
            })
            .catch(err => console.error('❌ XML 저장 실패:', err));
        });

        // ------ 초기 다이어그램 로드 ------
        fetch('./xml/test1.xml')
          .then(r => r.text())
          .then(async xml => {
            try {
              await bpmnModeler.importXML(xml);
              // 보기 보정 (원 코드 유지)
              const canvas = bpmnModeler.get('canvas');
              requestAnimationFrame(() => {
                const viewbox = canvas.viewbox();
                canvas.viewbox({ x: -40, y: 0, width: viewbox.width, height: viewbox.height });
              });
              const elementRegistry = bpmnModeler.get('elementRegistry');
              const moddle = bpmnModeler.get('moddle');
              const modeling = bpmnModeler.get('modeling');

              elementRegistry.forEach(el => {
                if (el.type === 'bpmn:Task') {
                  // extensionProperties 생성
                  const extensionProperties = moddle.create('camunda:Properties', {
                    values: [
                      moddle.create('camunda:Property', {
                        name: '화면명',
                        value: '',
                      }),
                      moddle.create('camunda:Property', {
                        name: '기타사항1',
                        value: '',
                      }),
                      moddle.create('camunda:Property', {
                        name: '기타사항2',
                        value: '',
                      }),
                    ],
                  });

                  // businessObject에 반영
                  el.businessObject.extensionElements = moddle.create('bpmn:ExtensionElements', {
                    values: [extensionProperties],
                  });
                }
              });
            } catch (err) {
              console.error('Failed to load BPMN diagram:', err);
            }
          });
      })();
    </script>
  </body>
</html>
